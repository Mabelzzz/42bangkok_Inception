# /etc/nginx/nginx.conf

# 1. Global Settings
# Run as the www-data user (standard for web servers on Debian/Ubuntu)
user www-data;
# Auto-detect number of CPU cores to determine worker processes
worker_processes auto;
# File to store the Process ID of the main nginx process
pid /run/nginx.pid;
# Include default modules (standard practice)
include /etc/nginx/modules-enabled/*.conf;

# 2. Events Block
# Handles connection processing
events {
    # Max simultaneous connections per worker
    worker_connections 1024;
}

# 3. HTTP Block
# Handles all web traffic settings
http {
    # -- Basic Settings --
    # Sendfile copies data between one FD and another from within the kernel (faster)
    sendfile on;
    # Timeout for keep-alive connections with the client
    keepalive_timeout 65;
    # Load MIME types (maps file extensions to content types)
    include /etc/nginx/mime.types;
    # Default type if MIME type is unknown
    default_type application/octet-stream;

    # -- SSL Settings (Global) --
    # Limit to secure TLS versions only (Required by 42 Subject)
    ssl_protocols TLSv1.2 TLSv1.3;
    # Prefer server ciphers over client ciphers
    ssl_prefer_server_ciphers on;

    # -- Server Block (Your Website) --
    server {
        # Listen on port 443 for IPv4 with SSL enabled
        listen 443 ssl;
        # Listen on port 443 for IPv6 with SSL enabled
        listen [::]:443 ssl;

        # Domain name for this server block
        server_name pnamwayk.42.fr;

        # SSL Certificate Paths (Generated in entrypoint.sh)
        ssl_certificate /etc/ssl/certs/inception.crt;
        ssl_certificate_key /etc/ssl/private/inception.key;

        # Web Root Directory (Mounted from WordPress volume)
        root /var/www/html;
        
        # Default files to serve
        index index.php index.html;

        # Location /: Handles standard requests
        location / {
            # Try to serve file ($uri), then folder ($uri/), then fall back to index.php
            # This is CRITICAL for WordPress permalinks to work.
            try_files $uri $uri/ /index.php?$args;
        }

        # Location ~.php$: Handles PHP files
        location ~ \.php$ {
            # Split URL for FastCGI
            include fastcgi_params;
            
            # Forward the request to the 'wordpress' container on port 9000
            # 'wordpress' is the service name defined in docker-compose.yml
            fastcgi_pass wordpress:9000;
            
            # Set the file index
            fastcgi_index index.php;
            
            # Tell PHP exactly which file to execute
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        }
    }
}